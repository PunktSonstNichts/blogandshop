jQuery(document).ready(function($) {
    function apiurl(product_id){
      return "https://api.zalando.com/articles/" + product_id;
    }

    // intext
    $("*:not(img)[data-zalando]").each(function( index ) {
      var elem = $(this);
      var product_id = elem.attr("data-zalando");
      var post_id = elem.attr("data-postid");
      var id = index;
      elem.attr("data-zalando", id);
      ajax(apiurl(product_id), {}, function(product){
        console.log(product);
        if(product.success && product.available){

          var options_html = "";
          var unit_count = 0;
          var price;
          $.each(product.units, function(i, unit){
            if(unit.available){
              unit_count++;
              options_html += "<option data-zalando_price='" + unit.price.formatted + "' value='" + unit.size + "'>" + unit.size + "</option>";
              single_html = "<input type='hidden' data-zalando_id='" + id + "' value='" + unit.size + "'/><div class='zalando_shop_sizeselect' data-zalando_id='" + id + "' data-zalando_price='" + unit.price.formatted + "'>" + unit.size + "</div>"; //TODO
              price = unit.price.formatted;
            }
          });


          var shop_html = "<div class='zalando_shop' data-zalando_id='" + id + "'>";
          shop_html += "<div class='zalando_shop_header'><div class='zalando_shop_header_main'><span class='zalando_shop_logo'>Zalando</span><span data-zalando_id='" + id + "' class='zalando_modal_err'></span></div> <span class='zalando_shop_close' data-zalando_id='" + id + "'>&times;</span></div>";
          shop_html += "<div class='zalando_shop_content'  data-zalando_id='" + id + "'>";
          shop_html += "<div class='zalando_shop_image'>";

          shop_html += "<div class='zalando_shop_image_main' data-zalando_id='" + id + "' style='background-image: url(" + product.media.images[0].mediumHdUrl + ")'></div>";

          shop_html += "<div class='zalando_shop_image_slider'>";
          $.each(product.media.images, function(i, image){
              active = (i == 0) ? "active" : "";
              shop_html += "<div class='zalando_shop_image_slider_img " + active + "' style='background-image: url(" + image.thumbnailHdUrl + ")' data-zalando_id='" + id + "' data-zalando_imgsrc='" + image.mediumHdUrl + "''></div>";
              shop_html += "<img src='" + image.mediumHdUrl + "' style='display:none;'><!-- Preload big img-->"
          });
          shop_html += "</div>"; //.zalando_shop_image_slider
          shop_html += "</div>"; //.zalando_shop_image
          shop_html += "<div class='zalando_shop_info'>";
          shop_html += "<div class='zalando_shop_details'>";
          shop_html += "<div class='zalando_shop_details_first'><span class='zalando_shop_details_brand'>" + product.brand.name + "</span><span class='zalando_shop_details_price' data-zalando_id='" + id + "'>";
          if(unit_count == 1){
            shop_html += price;
          }
          shop_html += "</span></div>";
          shop_html += "<div class='zalando_shop_name'>" + product.name + "</div>";
          shop_html += "</div>"; //.zalando_shop_details

          shop_html += "<div class='zalando_shop_select_wrapper'>";


          if(unit_count > 1){
            shop_html += "<select class='zalando_shop_sizeselect' data-zalando_id='" + id + "'>";
            shop_html += "<option data-zalando_price='' value='undefined'>Size</option>";
            shop_html += options_html;
            shop_html += "</select>";
          }else{
            shop_html += single_html;
          }
          shop_html += "</div>"; // .zalando_shop_select_wrapper

          shop_html += "<div class='zalando_shop_buybtn_wrapper'><a href='" + product.shopUrl + "' target='_blank' class='zalando_shop_link'>view details</a><button class='zalando_shop_buybtn' data-zalando_id='" + id + "' data-postid='" + post_id + "'>Buy now</button></div>"
          shop_html += "</div>"; // .zalando_shop_info
          shop_html += "</div>"; // .zalando_shop_content

          shop_html += "<div class='zalando_shop_checkout' data-zalando_id='" + id + "'>";
          shop_html += "<div class='zalando_shop_checkout_main'>";
          shop_html += "<div class='zalando_shop_checkout_overview' data-postid='" + post_id + "'>";
          shop_html += "<div class='zalando_shop_checkout_item' data-zalando_id='" + id + "'>"
          shop_html += "<div class='zalando_shop_checkout_item_img' style='background-image: url(" + product.media.images[0].mediumHdUrl + ")'></div>"
          shop_html += "<div class='zalando_shop_checkout_item_info'><div class='zalando_shop_checkout_item_price' data-zalando_id='" + id + "'></div><div class='zalando_shop_checkout_item_back'>back to item</div></div>";
          shop_html += "</div>"; // .zalando_shop_checkout_item
          shop_html += "</div>"; // .zalando_shop_checkout_overview
          shop_html += "<div class='zalando_shop_checkout_form'>";
          shop_html += "<div class='zalando_shop_checkout_form_item'>";
          shop_html += "<span>FULL NAME</span>";
          shop_html += "<input class='zalando_shop_checkout_form_input' name='full_name'>";
          shop_html += "</div>"; // .zalando_shop_checkout_form_item
          shop_html += "<div class='zalando_shop_checkout_form_item'>";
          shop_html += "<span>EMAIL</span>";
          shop_html += "<input class='zalando_shop_checkout_form_input' name='e_mail'>";
          shop_html += "</div>"; // .zalando_shop_checkout_form_item
          shop_html += "<div class='zalando_shop_checkout_form_item'>";
          shop_html += "<span>STREET ADDRESS</span>";
          shop_html += "<input class='zalando_shop_checkout_form_input' name='street_address'>";
          shop_html += "</div>"; // .zalando_shop_checkout_form_item
          shop_html += "<div class='zalando_shop_checkout_form_item'>";
          shop_html += "<span>POSTAL CODE + CITY</span>";
          shop_html += "<input class='zalando_shop_checkout_form_input' name='postal_code_city'>";
          shop_html += "</div>"; // .zalando_shop_checkout_form_item
          shop_html += "<div class='zalando_shop_checkout_form_item'>";
          shop_html += "<span>PAYMENT</span>";
          shop_html += "<div class='payment_sel_wrap'>";
          shop_html += "<div class='payment_sel'><input type='radio' name='payment' value='visa' id='" + id + "visa'><label for='" + id + "visa'>VISA</label></div>";
          shop_html += "<div class='payment_sel'><input type='radio' name='payment' value='paypal' id='" + id + "paypal'><label for='" + id + "paypal'>PAYPAL</label></div>";
          shop_html += "<div class='payment_sel'><input type='radio' name='payment' value='maestro' id='" + id + "maestro'><label for='" + id + "maestro'>MAESTRO</label></div>";
          shop_html += "</div>";
          shop_html += "</div>"; // .zalando_shop_checkout_form_item
          shop_html += "</div>"; // .zalando_shop_checkout_form
          shop_html += "</div>"; // .zalando_shop_checkout_main
          shop_html += "<div class='zalando_shop_checkout_btn_wrapper'>";
          shop_html += "<button class='zalando_shop_checkout_btn' data-zalando_id='" + id + "' data-postid='" + post_id + "'>CHECKOUT</button>"
          shop_html += "</div>";
          shop_html += "</div>"; // .zalando_shop_checkout
          shop_html += "</div>";
          elem.after(shop_html);


          elem.addClass("active");
        }
      });
    });

    //in image
    $("img[data-zalando]").each(function( index ) {
      var elem = $(this);
      var product_id = elem.attr("data-zalando");
      var post_id = elem.attr("data-postid");
      var id = index;
      elem.attr("data-zalando", id);
      ajax(apiurl(product_id), {}, function(product){
        console.log(product);
        if(product.success && product.available){
          var img_shop_html = "";
          //CHECK HERE WHAT KIND OF SHOP SHOULD BE INCLUDED
          /*
           - a link if image is quite small
           - a btn for opening the shop if event handler is registerd for the image (diashow, lightbox, ...)
           - shop overlay if enough space AND no interfering with other code
          */
          console.log(elem.height());
          if(elem.height() <= 350 || elem.width() <= 320){
            // only insert little link
            img_shop_html += "<div class='zalando_img_shop_wrapper' data-zalando_id='" + id + "'><a class='zalando_img_activate' href='" + product.shopUrl + "' target='_blank'>Buy @ Zalando</a></div>";
          }else{

            var options_html = "";
            var unit_count = 0;
            var price;
            $.each(product.units, function(i, unit){
              if(unit.available){
                unit_count++;
                options_html += "<option data-zalando_price='" + unit.price.formatted + "' value='" + unit.size + "'>" + unit.size + "</option>";
                single_html = "<input type='hidden' data-zalando_id='" + id + "' value='" + unit.size + "'/><div class='zalando_shop_sizeselect' data-zalando_id='" + id + "' data-zalando_price='" + unit.price.formatted + "'>" + unit.size + "</div>"; //TODO
                price = unit.price.formatted;
              }
            });


            img_shop_html += "<div class='zalando_img_shop_wrapper' data-zalando_id='" + id + "'><button class='zalando_img_activate' data-zalando_id='" + id + "'>buy product here</button><div data-zalando_id='" + id + "' class='zalando_img_shop'>"
            img_shop_html += "<div class='zalando_shop_header'><div class='zalando_shop_header_main'><span class='zalando_shop_logo'>Zalando</span><span data-zalando_id='" + id + "' class='zalando_modal_err'></span></div> <span class='zalando_shop_close' data-zalando_id='" + id + "'>&times;</span></div>";
            img_shop_html += "<div class='zalando_shop_content'  data-zalando_id='" + id + "'>";
            img_shop_html += "<div class='zalando_shop_image'>";

            img_shop_html += "<div class='zalando_shop_image_main' data-zalando_id='" + id + "' style='background-image: url(" + product.media.images[0].mediumHdUrl + ")'></div>";

            img_shop_html += "<div class='zalando_shop_image_slider'>";
            $.each(product.media.images, function(i, image){
                active = (i == 0) ? "active" : "";
                img_shop_html += "<div class='zalando_shop_image_slider_img " + active + "' style='background-image: url(" + image.thumbnailHdUrl + ")' data-zalando_id='" + id + "' data-zalando_imgsrc='" + image.mediumHdUrl + "''></div>";
                img_shop_html += "<img src='" + image.mediumHdUrl + "' style='display:none;'><!-- Preload big img-->"
            });
            img_shop_html += "</div>"; //.zalando_shop_image_slider
            img_shop_html += "</div>"; //.zalando_shop_image
            img_shop_html += "<div class='zalando_shop_info'>";
            img_shop_html += "<div class='zalando_shop_details'>";
            img_shop_html += "<div class='zalando_shop_details_first'><span class='zalando_shop_details_brand'>" + product.brand.name + "</span><span class='zalando_shop_details_price' data-zalando_id='" + id + "'>";
            if(unit_count == 1){
              img_shop_html += price;
            }
            img_shop_html += "</span></div>";
            img_shop_html += "<div class='zalando_shop_name'>" + product.name + "</div>";
            img_shop_html += "</div>"; //.zalando_shop_details

            img_shop_html += "<div class='zalando_shop_select_wrapper'>";
            if(unit_count > 1){
              img_shop_html += "<select class='zalando_shop_sizeselect' data-zalando_id='" + id + "'>";
              img_shop_html += "<option data-zalando_price='' value='undefined'>Size</option>";
              img_shop_html += options_html;
              img_shop_html += "</select>";
            }else{
              img_shop_html += single_html;
            }
            img_shop_html += "</div>"; // .zalando_shop_select_wrapper

            img_shop_html += "<div class='zalando_shop_buybtn_wrapper'><a href='" + product.shopUrl + "' target='_blank' class='zalando_shop_link'>view details</a></div>"
            img_shop_html += "</div>"; // .zalando_shop_info
            img_shop_html += "<button class='zalando_shop_buybtn' data-zalando_id='" + id + "' data-postid='" + post_id + "' style='width: 100%;'>Buy now</button>";
            img_shop_html += "</div>"; // .zalando_shop_content

            img_shop_html += "<div class='zalando_shop_checkout' data-zalando_id='" + id + "'>";
            img_shop_html += "<div class='zalando_shop_checkout_main'>";
            img_shop_html += "<div class='zalando_shop_checkout_overview' data-postid='" + post_id + "'>";
            img_shop_html += "<div class='zalando_shop_checkout_item' data-zalando_id='" + id + "'>"
            img_shop_html += "<div class='zalando_shop_checkout_item_img' style='background-image: url(" + product.media.images[0].mediumHdUrl + ")'></div>"
            img_shop_html += "<div class='zalando_shop_checkout_item_info'><div class='zalando_shop_checkout_item_price' data-zalando_id='" + id + "'></div><div class='zalando_shop_checkout_item_back'>back to item</div></div>";
            img_shop_html += "</div>"; // .zalando_shop_checkout_item
            img_shop_html += "</div>"; // .zalando_shop_checkout_overview
            img_shop_html += "<div class='zalando_shop_checkout_form'>";
            img_shop_html += "<div class='zalando_shop_checkout_form_item'>";
            img_shop_html += "<span>FULL NAME</span>";
            img_shop_html += "<input class='zalando_shop_checkout_form_input' name='full_name'>";
            img_shop_html += "</div>"; // .zalando_shop_checkout_form_item
            img_shop_html += "<div class='zalando_shop_checkout_form_item'>";
            img_shop_html += "<span>EMAIL</span>";
            img_shop_html += "<input class='zalando_shop_checkout_form_input' name='e_mail'>";
            img_shop_html += "</div>"; // .zalando_shop_checkout_form_item
            img_shop_html += "<div class='zalando_shop_checkout_form_item'>";
            img_shop_html += "<span>STREET ADDRESS</span>";
            img_shop_html += "<input class='zalando_shop_checkout_form_input' name='street_address'>";
            img_shop_html += "</div>"; // .zalando_shop_checkout_form_item
            img_shop_html += "<div class='zalando_shop_checkout_form_item'>";
            img_shop_html += "<span>POSTAL CODE + CITY</span>";
            img_shop_html += "<input class='zalando_shop_checkout_form_input' name='postal_code_city'>";
            img_shop_html += "</div>"; // .zalando_shop_checkout_form_item
            img_shop_html += "<div class='zalando_shop_checkout_form_item'>";
            img_shop_html += "<span>PAYMENT</span>";
            img_shop_html += "<div class='payment_sel_wrap'>";
            img_shop_html += "<div class='payment_sel'><input type='radio' name='payment' value='visa' id='" + id + "visa'><label for='" + id + "visa'>VISA</label></div>";
            img_shop_html += "<div class='payment_sel'><input type='radio' name='payment' value='paypal' id='" + id + "paypal'><label for='" + id + "paypal'>PAYPAL</label></div>";
            img_shop_html += "<div class='payment_sel'><input type='radio' name='payment' value='maestro' id='" + id + "maestro'><label for='" + id + "maestro'>MAESTRO</label></div>";
            img_shop_html += "</div>";
            img_shop_html += "</div>"; // .zalando_shop_checkout_form_item
            img_shop_html += "</div>"; // .zalando_shop_checkout_form
            img_shop_html += "</div>"; // .zalando_shop_checkout_main
            img_shop_html += "<div class='zalando_shop_checkout_btn_wrapper'>";
            img_shop_html += "<button class='zalando_shop_checkout_btn' data-zalando_id='" + id + "' data-postid='" + post_id + "'>CHECKOUT</button>"
            img_shop_html += "</div>";
            img_shop_html += "</div>"; // .zalando_shop_checkout
            img_shop_html += "</div></div>";
          }

          elem.css("margin", 0).css("padding", 0).wrap("<div class='zalando_img_wrapper hover' data-zalando_id='" + id + "' data-postid='" + post_id + "'></div>");

          $(".zalando_img_wrapper[data-zalando_id='" + id + "']").append(img_shop_html);
        }
      });
    });

    var touchonly = true;

    $(document).on("click", ".active[data-zalando]", function(e) {
      var id = $(this).attr("data-zalando");
      $(".zalando_shop[data-zalando_id='" + id + "']").toggleClass("active");
    }).on("click", ".zalando_shop_image_slider_img", function(e){
      var id = $(this).attr("data-zalando_id");
      var imgsrc = $(this).attr("data-zalando_imgsrc");

      $(".zalando_shop_image_main[data-zalando_id='" + id + "']").css("background-image", "url(" + imgsrc + ")");

      $(".zalando_shop_image_slider_img[data-zalando_id='" + id + "']").removeClass("active");
      $(this).addClass("active");
    }).on("change", "select.zalando_shop_sizeselect", function(){
      var id = $(this).attr("data-zalando_id");
      var price = $("select[data-zalando_id='" + id + "'] option:selected").attr("data-zalando_price");
      $(".zalando_shop_details_price[data-zalando_id='" + id + "']").html(price);
    }).on("click", ".zalando_shop_close", function(){
      var id = $(this).attr("data-zalando_id");
      $(".zalando_shop[data-zalando_id='" + id + "']").removeClass("active");
      $(".zalando_img_shop[data-zalando_id='" + id + "']").removeClass("active");
      $(".zalando_img_wrapper[data-zalando_id='" + id + "']").removeClass("active");
      // RESET VIEW
        $(".zalando_shop_content[data-zalando_id='" + id + "']").show();
        $(".zalando_shop_checkout[data-zalando_id='" + id + "']").hide();
    }).on("click", ".zalando_shop_buybtn", function(){
      var id = $(this).attr("data-zalando_id");
      var price = $("select[data-zalando_id='" + id + "'] option:selected").attr("data-zalando_price") ? $("select[data-zalando_id='" + id + "'] option:selected").attr("data-zalando_price") : $(".zalando_shop_sizeselect[data-zalando_id='" + id + "']").attr("data-zalando_price");
      console.log(price);
      if(price && price.length > 1){
        $(".zalando_shop_checkout_item_price[data-zalando_id='" + id + "']").html(price);
        $(".zalando_shop_content[data-zalando_id='" + id + "']").hide();
        $(".zalando_shop_checkout[data-zalando_id='" + id + "']").show();
      }else{
        $(".zalando_modal_err[data-zalando_id='" + id + "']").html("please select size first").stop(true, true).fadeIn().delay(4000).fadeOut();
      }
    }).on("click", ".zalando_shop_checkout_item", function(){
      var id = $(this).attr("data-zalando_id");
      $(".zalando_shop_content[data-zalando_id='" + id + "']").show();
      $(".zalando_shop_checkout[data-zalando_id='" + id + "']").hide();
    }).on("mousemove", function(){
      //this is for mobile devices:
      // If there is no mousemove -> touchonly -> never hide btn
      if(touchonly){
        $(".zalando_img_wrapper").removeClass("hover");
        touchonly = false;
      }
    }).on("mouseover", ".zalando_img_wrapper", function(){
      $(this).addClass("hover");
    }).on("mouseout", ".zalando_img_wrapper", function(){
      if(!$(this).hasClass("active")){
        $(this).removeClass("hover");
      }
    }).on("click", ".zalando_img_shop_wrapper", function(e){
      var id = $(this).attr("data-zalando_id");
      if(!$(".zalando_img_wrapper[data-zalando_id='" + id + "']").hasClass("active")){
        console.log(e);
      }
    }).on("click", "button.zalando_img_activate", function(e){
      e.stopPropagation();
      var id = $(this).attr("data-zalando_id");
      $(".zalando_img_shop[data-zalando_id='" + id + "']").addClass("active");
      $(".zalando_img_wrapper[data-zalando_id='" + id + "']").addClass("active");
    });




    function ajax(url, data, response){
      if(!navigator.onLine && false){
        response({success: false, msg: "Connection to the internet needed, but not possible"});
      }else{
        $.ajaxSetup({
          beforeSend: function(xhr) {
                xhr.withCredentials = true;
                xhr.setRequestHeader('Accept', 'application/json');
            }
        });
        console.log("Sending data");
        $.ajax({
          url: url,
          data: data,
          type: "GET",
          dataType: "json",
          error: function(data) {
                  response({success: false, msg: "Sorry, something went wrong. Seems like there is an http error somewhere."});
          },
          success: function(data, textStatus, jqXHR) {
            data.received = Date.now();
            data.success = true;
            response(data);
          }
        });
      }
    }
});
